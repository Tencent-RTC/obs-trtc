<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TRTC-OBS-WHIP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js"></script>
    <script charset="UTF-8" src="./sensorsdata.min.js"></script>
    <script charset="UTF-8">
      var sensors = window['sensorsDataAnalytic201505'];
      sensors.init({
        server_url: 'https://statistics.woa.com/sa?project=production',
        cross_subdomain:false,
        heatmap:{clickmap:'default', scroll_notice_map:'default'},
        is_track_single_page:true,
        use_client_time:true,
        send_type:'beacon'
      });
      sensors.quick('autoTrack');
    </script>
</head>
<body>
<div class="container">
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
            <a class="navbar-brand" href="javascript:void(0)">TRTC</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="https://discord.gg/vDHty6ddrZ" target="_blank">Discord</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="https://twitter.com/TencentRTC" target="_blank">Twitter</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="https://github.com/Tencent-RTC/obs-trtc" target="_blank">GitHub</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="accordion">
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                    Settings
                </button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse">
                <div class="accordion-body">
                    <div class="mb-3">
                        <div class="row g-3 align-items-center">
                            <div class="col-auto">
                                <label for="txtSDKAppID" class="form-label">SDKAppID</label>
                            </div>
                            <div class="col-auto">
                                <input type="text" class="form-control" id="txtSDKAppID">
                            </div>
                            <div class="col-auto">
                                *
                                <a href="https://github.com/Tencent-RTC/obs-trtc#step-1-create-a-trtc-application" target="_blank" class="link-opacity-50-hover">
                                    Get a SDKAppID
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="row g-3 align-items-center">
                            <div class="col-auto">
                                <label for="txtSDKSecretKey" class="form-label">SDKSecretKey</label>
                            </div>
                            <div class="col-auto">
                                <input type="text" class="form-control" id="txtSDKSecretKey">
                            </div>
                            <div class="col-auto">
                                *
                                <a href="https://github.com/Tencent-RTC/obs-trtc#step-1-create-a-trtc-application" target="_blank" class="link-opacity-50-hover">
                                    Get a SDKSecretKey
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="row g-3 align-items-center">
                            <div class="col-auto">
                                <label for="txtStreamID" class="form-label">StreamID</label>
                            </div>
                            <div class="col-auto">
                                <input type="text" class="form-control" id="txtStreamID"></input>
                            </div>
                        </div>
                    </div>
                    <div id="generateBearerToken" class="mb-3">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <button class="btn btn-primary" id="btnGenerate">Generate Bearer Token</button>
                            </div>
                            <div class="col-auto">
                                * <a href="https://discord.gg/vDHty6ddrZ" target="_blank" class="link-opacity-50-hover">
                                    Need help and support?
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="accordion-item" id="accordionOne">
            <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                    OBS WHIP
                </button>
            </h2>
            <div id="collapseTwo" class="accordion-collapse collapse show">
                <div class="accordion-body">
                    <div class="mb-3">
                        <label for="txtService" class="form-label">Service</label>
                        <span class="form-control" id="txtService">WHIP</span>
                    </div>
                    <div class="mb-3">
                        <label for="txtWHIPServer" class="form-label">Server</label>
                        <input type="text" class="form-control" id="txtWHIPServer">
                    </div>
                    <div class="mb-3">
                        <label for="txtWHIPBearerToken" class="form-label">Bearer Token</label>
                        <input type="text" class="form-control" id="txtWHIPBearerToken">
                    </div>
                    <div class="mb-3">
                        * <a href="https://github.com/Tencent-RTC/obs-trtc#step-3-configure-obs" target="_blank" class="link-opacity-50-hover">
                            Learn how to configure OBS?
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="accordion-item" id="accordionTwo">
            <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour">
                    WHEP Player
                </button>
            </h2>
            <div id="collapseFour" class="accordion-collapse collapse show">
                <div class="accordion-body">
                    <div class="mb-3">
                        <label for="txtWHEPServer" class="form-label">Server</label>
                        <input type="text" class="form-control" id="txtWHEPServer">
                    </div>
                    <div class="mb-3">
                        <label for="txtWHEPBearerToken" class="form-label">Bearer Token</label>
                        <input type="text" class="form-control" id="txtWHEPBearerToken">
                    </div>
                    <div class="mb-3">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <button class="btn btn-primary" id="btnPlay">Play Stream</button>
                            </div>
                            <div class="col-auto">
                                * <a href="https://discord.gg/vDHty6ddrZ" target="_blank" class="link-opacity-50-hover">
                                    Need help and support?
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <video id="whepPlayer" controls="controls" autoplay />
                    </div>
                </div>
            </div>
        </div>
        <div class="accordion-item" id="accordionThree">
            <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive">
                    TRTC Room
                </button>
            </h2>
            <div id="collapseFive" class="accordion-collapse collapse show">
                <div class="accordion-body">
                    <div class="row">
                        <div class="col mb-3">
                            <label for="txtSDKAppID2" class="form-label">SDKAppID</label>
                            <input type="text" class="form-control" id="txtSDKAppID2">
                        </div>
                        <div class="col mb-3">
                            <label for="txtRoomID" class="form-label">Room</label>
                            <input type="text" class="form-control" id="txtRoomID">
                        </div>
                        <div class="col mb-3">
                            <label for="txtUserID" class="form-label">UserID</label>
                            <input type="text" class="form-control" id="txtUserID">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="txtUserSig" class="form-label">UserSig</label>
                        <input type="text" class="form-control" id="txtUserSig">
                    </div>
                    <div class="mb-3">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <button class="btn btn-primary" id="btnJoin">Join Room</button>
                            </div>
                            <div class="col-auto">
                                * <a href="https://discord.gg/vDHty6ddrZ" target="_blank" class="link-opacity-50-hover">
                                    Need help and support?
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div id="trtcPlayer" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src='./lib-generate-test-usersig.min.js'></script>
<script type="text/javascript">
    $(function(){
        console.log(`?appid=xxx Overwrite the TRTC_APPID environment variable.`);
        console.log(`?secret=xxx Overwrite the TRTC_SECRETKEY environment variable.`);
        console.log(`?stream=xxx Setup the stream ID for WHIP, or room ID for TRTC.`);

      const u = new URL(window.location.href);
        // Remove the query string and save to localStorage.
        u.searchParams.get("appid") && localStorage.setItem("whip_appid", u.searchParams.get("appid"));
        u.searchParams.get("secret") && localStorage.setItem("whip_secret", u.searchParams.get("secret"));
        u.searchParams.get("stream") && localStorage.setItem("whip_stream", u.searchParams.get("stream"));
        if (u.searchParams.get("appid") || u.searchParams.get("secret") || u.searchParams.get("stream")) {
            u.searchParams.delete("appid");
            u.searchParams.delete("secret");
            u.searchParams.delete("stream");
            window.location.href = u.toString();
            return;
        }

        // Only load values from localStorage.
        const SDKAppID = localStorage.getItem("whip_appid");
        const SDKSecretKey = localStorage.getItem("whip_secret");
        const streamID = localStorage.getItem("whip_stream") || Math.random().toString(16).slice(-7);

        SDKAppID && $("#txtSDKAppID").val(SDKAppID);
        SDKSecretKey && $("#txtSDKSecretKey").val(SDKSecretKey);
        $("#txtStreamID").val(streamID);

        $("#btnGenerate").click(() => {
            $("#txtSDKAppID").val() && localStorage.setItem("whip_appid", $("#txtSDKAppID").val());
            $("#txtSDKSecretKey").val() && localStorage.setItem("whip_secret", $("#txtSDKSecretKey").val());
            $("#txtStreamID").val() && localStorage.setItem("whip_stream", $("#txtStreamID").val());
            location.reload();
        });

        if (!SDKAppID || !SDKSecretKey) {
            $('#accordionOne').hide();
            $('#accordionTwo').hide();
            $('#accordionThree').hide();
            $('#collapseOne').addClass('show');
            return;
        }

        const expireSeconds = 3600;
        const whipSessionID = Math.random().toString(16).slice(-9);
        const whipUserSig = new LibGenerateTestUserSig(parseInt(SDKAppID), SDKSecretKey, expireSeconds).genTestUserSig(whipSessionID);
        const whipServer = `https://signaling.rtc.tencentcloud.com/v2/pub/${SDKAppID}/${streamID}?SessionID=${whipSessionID}`;
        $('#txtWHIPServer').val(whipServer);
        $('#txtWHIPBearerToken').val(whipUserSig);

        const whepSessionID = Math.random().toString(16).slice(-9);
        const whepUserSig = new LibGenerateTestUserSig(parseInt(SDKAppID), SDKSecretKey, expireSeconds).genTestUserSig(whepSessionID);
        const whepServer = `https://signaling.rtc.tencentcloud.com/v2/sub/${SDKAppID}/${streamID}?SessionID=${whepSessionID}`;
        $('#txtWHEPServer').val(whepServer);
        $('#txtWHEPBearerToken').val(whepUserSig);

        const trtcUserID = Math.random().toString(16).slice(-9);
        const trtcUserSig = new LibGenerateTestUserSig(parseInt(SDKAppID), SDKSecretKey, expireSeconds).genTestUserSig(trtcUserID);
        $('#txtSDKAppID2').val(SDKAppID);
        $('#txtRoomID').val(streamID);
        $('#txtUserID').val(trtcUserID);
        $('#txtUserSig').val(trtcUserSig);
    });
</script>

<script src='https://web.sdk.qcloud.com/trtc/webrtc/v5/npm-package/trtc.js'></script>
<script type="text/javascript">
    $(function(){
        const trtc = TRTC.create();
        trtc.on(TRTC.EVENT.REMOTE_VIDEO_AVAILABLE, ({ userId, streamType }) => {
            console.log(`[WHIP] Remote video available: userId=${userId} streamType=${streamType}`);
            trtc.startRemoteVideo({ userId, streamType, view: 'trtcPlayer' });
        });
        const joinRoom = async function() {
            $('#trtcPlayer').show();

            const sdkAppId = parseInt($("#txtSDKAppID2").val());
            const roomId = $("#txtRoomID").val();
            const userId = $("#txtUserID").val();
            const userSig = $("#txtUserSig").val();

            await trtc.exitRoom();
            await trtc.enterRoom({ roomId, sdkAppId, userId, userSig });
        };

        $('#trtcPlayer').hide();
        $("#btnJoin").click(() => {
            $("#btnJoin").attr("disabled", true);
            setTimeout(() => $("#btnJoin").attr("disabled", false), 3000);
            joinRoom();
        });
    });
</script>

<script type="text/javascript">
$(function(){
    var whep = null;
    const startPlay = async function() {
        $('#whepPlayer').show();

        if (whep) {
            whep.close();
        }
        whep = new SrsRtcWhipWhepAsync();
        whep.bearer = $("#txtWHEPBearerToken").val();
        $('#whepPlayer').prop('srcObject', whep.stream);

        // For example: webrtc://r.ossrs.net/live/livestream
        var url = $("#txtWHEPServer").val();
        const session = await whep.play(url);
        console.log('Play success', session);
    };

    $('#whepPlayer').hide();
    $("#btnPlay").click(() => {
        $("#btnPlay").attr("disabled", true);
        setTimeout(() => $("#btnPlay").attr("disabled", false), 3000);
        startPlay();
    });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/webrtc-adapter@8.2.2/out/adapter.min.js"></script>
<script type="text/javascript">
  // Depends on adapter-7.4.0.min.js from https://github.com/webrtc/adapter
  // Async-awat-prmise based SRS RTC Publisher by WHIP.
  function SrsRtcWhipWhepAsync() {
    var self = {
      bearer: null, // The Bearer Token for WHIP.
    };

    // See https://datatracker.ietf.org/doc/draft-ietf-wish-whip/
    // @url The WebRTC url to play with, for example:
    //      http://localhost:1985/rtc/v1/whip-play/?app=live&stream=livestream
    self.play = async function(url) {
      self.pc.addTransceiver("audio", {direction: "recvonly"});
      self.pc.addTransceiver("video", {direction: "recvonly"});

      var offer = await self.pc.createOffer();
      await self.pc.setLocalDescription(offer);
      const answer = await new Promise(function(resolve, reject) {
        console.log("Generated offer: ", offer);

        const xhr = new XMLHttpRequest();
        xhr.onload = function() {
          if (xhr.readyState !== xhr.DONE) return;
          if (xhr.status !== 200 && xhr.status !== 201) return reject(xhr);
          const data = xhr.responseText;
          console.log("Got answer: ", data);
          return data.code ? reject(xhr) : resolve(data);
        }
        xhr.open('POST', url, true);
        xhr.setRequestHeader('Content-type', 'application/sdp');
        self.bearer && xhr.setRequestHeader('Authorization', `Bearer ${self.bearer}`);
        xhr.send(offer.sdp);
      });
      await self.pc.setRemoteDescription(
        new RTCSessionDescription({type: 'answer', sdp: answer})
      );

      return self.__internal.parseId(url, offer.sdp, answer);
    };

    // Close the publisher.
    self.close = function () {
      self.pc && self.pc.close();
      self.pc = null;
    };

    // The callback when got local stream.
    // @see https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection/addStream#Migrating_to_addTrack
    self.ontrack = function (event) {
      // Add track to stream of SDK.
      self.stream.addTrack(event.track);
    };

    self.pc = new RTCPeerConnection(null);

    // To keep api consistent between player and publisher.
    // @see https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection/addStream#Migrating_to_addTrack
    // @see https://webrtc.org/getting-started/media-devices
    self.stream = new MediaStream();

    // Internal APIs.
    self.__internal = {
      parseId: (url, offer, answer) => {
        return {url, offer, answer};
      },
    };

    // https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection/ontrack
    self.pc.ontrack = function(event) {
      if (self.ontrack) {
        self.ontrack(event);
      }
    };

    return self;
  }
</script>

</body>
</html>
